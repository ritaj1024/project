<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>AMS å®¶å®¢ç»ˆç«¯ç®¡ç† Â· è°ƒæ‹¨å‡ºå…¥åº“ + æ•…éšœç»ˆç«¯é—­ç¯ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: #f3f4f6;
    }
    body { display: flex; justify-content: center; align-items: center; padding: 16px; }

    .phone-frame {
      width: 390px;
      max-width: 100%;
      height: 780px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    header {
      height: 56px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 16px;
      font-weight: 600;
    }
    header .title-sub {
      font-size: 11px;
      font-weight: 400;
      opacity: 0.9;
    }

    main {
      flex: 1;
      overflow-y: auto;
      background: #f3f4f6;
      padding: 10px 12px 72px;
    }

    .view { display: none; }
    .view.active { display: block; }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .card-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .badge-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .badge-draft { background:#eef2ff;color:#4f46e5; }
    .badge-pending { background:#fef3c7;color:#92400e; }
    .badge-pass { background:#dcfce7;color:#166534; }
    .badge-reject { background:#fee2e2;color:#b91c1c; }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 11px;
    }
    .step-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      color: #9ca3af;
    }
    .step-circle {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: #fff;
    }
    .step-item.active .step-circle {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .step-item.active span.label {
      color: #2563eb;
      font-weight: 600;
    }
    .step-line {
      position: relative;
      top: 9px;
      flex: 1;
      height: 1px;
      background: #e5e7eb;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 8px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .form-field { display:flex;flex-direction:column;gap:2px; }
    .form-label { font-size:11px;color:#4b5563; }
    .form-label span.required { color:#ef4444;margin-left:2px; }
    input[type="text"], select, textarea {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      font-size: 11px;
      outline: none;
      resize: none;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
    }
    textarea { min-height: 40px; }

    .btn {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #374151;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#1d4ed8);
      border-color: #1d4ed8;
      color: #fff;
    }
    .btn-outline { background:#fff;border-color:#d1d5db; }
    .btn-danger { background:#fee2e2;border-color:#fecaca;color:#b91c1c; }
    .btn-ghost-dark { background:transparent;border-color:rgba(148,163,184,0.8);color:#e5e7eb; }
    .btn:disabled { opacity:.6;cursor:not-allowed; }

    .divider { height:1px;background:#e5e7eb;margin:8px 0; }
    .hint { font-size:10px;color:#6b7280; }

    .camera-box {
      border-radius: 14px;
      background: #020617;
      padding: 8px 8px 10px;
      color: #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    .camera-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      margin-bottom: 4px;
      color: #e5e7eb;
      opacity: 0.9;
    }
    .camera-view {
      position: relative;
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.9);
      overflow: hidden;
      height: 200px;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }
    video#cameraVideo { width:100%;height:100%;object-fit:cover; }
    .camera-overlay {
      pointer-events: none;
      position: absolute;
      inset: 8px;
      border-radius: 10px;
    }
    .corner {
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid #38bdf8;
    }
    .corner.tl{top:0;left:0;border-right:none;border-bottom:none;}
    .corner.tr{top:0;right:0;border-left:none;border-bottom:none;}
    .corner.bl{bottom:0;left:0;border-right:none;border-top:none;}
    .corner.br{bottom:0;right:0;border-left:none;border-top:none;}
    .scan-line{
      position:absolute;left:10px;right:10px;top:50%;
      height:1px;background:linear-gradient(to right,transparent,#22c55e,transparent);
      box-shadow:0 0 5px #22c55e;opacity:.9;
    }

    .code-tags {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .code-tag {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: #e5e7eb;
    }
    .code-tag-type {
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.4);
      color: #bfdbfe;
    }
    .code-tag.active {
      border-color: #38bdf8;
      background: rgba(15, 118, 110, 0.9);
    }

    .camera-summary {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 6px;
      font-size: 10px;
    }
    .camera-summary-block {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 8px;
      padding: 6px 7px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
    }
    .camera-summary-title { font-size:10px;font-weight:500;margin-bottom:3px; }
    .camera-summary-row{display:flex;justify-content:space-between;margin-top:2px;}
    .camera-summary-row span.key{color:#9ca3af;}
    .camera-summary-row span.val{color:#f9fafb;}

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 10px;
      font-size: 11px;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    .info-item-label {
      color: #6b7280;
      margin-bottom: 2px;
    }
    .info-item-value {
      font-weight: 500;
      color: #111827;
      min-height: 16px;
      word-break: break-all;
    }
    .info-item-value.bad { color:#b91c1c; }
    .info-item-value.good { color:#15803d; }

    .device-list {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: 160px;
      overflow-y: auto;
      font-size: 11px;
    }
    .device-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      border-bottom: 1px dashed #e5e7eb;
      align-items: center;
    }
    .device-row:last-child { border-bottom:none; }
    .device-meta { max-width:230px; }
    .device-meta-line {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .timeline { margin-top:6px;font-size:11px;color:#4b5563; }
    .timeline-item {
      position:relative;
      padding-left:12px;
      margin-bottom:4px;
    }
    .timeline-item::before{
      content:"";position:absolute;left:3px;top:3px;
      width:6px;height:6px;border-radius:999px;background:#2563eb;
    }
    .timeline-item::after{
      content:"";position:absolute;left:5px;top:10px;
      width:1px;height:16px;background:#e5e7eb;
    }
    .timeline-item:last-child::after{display:none;}

    .order-item {
      font-size: 11px;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-bottom: 6px;
      background: #fff;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      align-items: center;
    }
    .order-title { font-size:12px;font-weight:600; }
    .order-meta {
      display:flex;
      justify-content:space-between;
      color:#6b7280;
      margin-top:2px;
    }
    .tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 6px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 30;
    }
    .modal-backdrop.active { display:flex; }
    .modal-panel {
      width: 100%;
      max-width: 360px;
      max-height: 90%;
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.4);
      overflow-y: auto;
      padding: 10px 12px 12px;
    }
    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .modal-title { font-size:14px;font-weight:600;color:#111827; }
    .modal-subtitle { font-size:11px;color:#6b7280;margin-bottom:6px; }
    .modal-close { font-size:20px;cursor:pointer;color:#6b7280; }

    .tab-bar {
      height: 54px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
    }
    .tab-item {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#6b7280;
      cursor:pointer;
    }
    .tab-item span.icon{font-size:16px;margin-bottom:2px;}
    .tab-item.active{color:#2563eb;}

    .fade-in{animation:fade-in .2s ease-out;}
    @keyframes fade-in{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }
  </style>
</head>
<body>
  <div class="phone-frame">
    <header>
      <div>
        <div id="headerTitle">è°ƒæ‹¨å‡ºå…¥åº“</div>
        <div class="title-sub" id="headerSubTitle">è®¢å•åˆ›å»º Â· æ‰«ç æ·»åŠ  Â· å®¡æ‰¹ç¡®è®¤</div>
      </div>
      <div style="font-size: 20px;">â‹®</div>
    </header>

    <main>
      <!-- è°ƒæ‹¨å‡ºå…¥åº“ä¸»æµç¨‹ -->
      <section id="view-transfer" class="view active fade-in">
        <div class="card">
          <div class="step-indicator">
            <div class="step-item active" data-step="1">
              <div class="step-circle">1</div>
              <span class="label">åˆ›å»ºè®¢å•</span>
            </div>
            <div class="step-line"></div>
            <div class="step-item" data-step="2">
              <div class="step-circle">2</div>
              <span class="label">æ‰«ç æ·»åŠ </span>
            </div>
            <div class="step-line"></div>
            <div class="step-item" data-step="3">
              <div class="step-circle">3</div>
              <span class="label">å®¡æ‰¹ç¡®è®¤</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>è®¢å•åŸºæœ¬ä¿¡æ¯</span>
            <span id="orderStatusBadge" class="badge-status badge-draft">è‰ç¨¿</span>
          </div>
          <div class="card-subtitle">
            å¡«å†™è°ƒæ‹¨å‡ºå…¥åº“è®¢å•ä¿¡æ¯ï¼Œä¿å­˜åå¯é€šè¿‡ã€æ‰«ç æ·»åŠ ã€‘å½•å…¥è®¾å¤‡ï¼Œå†é€šè¿‡å®¡æ‰¹ç¡®è®¤å®Œæˆæ­¤è®¢å•æµç¨‹ã€‚
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="form-label">è®¢å•ç±»å‹<span class="required">*</span></label>
              <select id="fieldOrderType">
                <option value="è°ƒæ‹¨å‡ºåº“">è°ƒæ‹¨å‡ºåº“</option>
                <option value="è°ƒæ‹¨å…¥åº“">è°ƒæ‹¨å…¥åº“</option>
              </select>
            </div>
            <div class="form-field">
              <label class="form-label">è®¢å•ç¼–å·</label>
              <input id="fieldOrderNo" type="text" placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" disabled />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="form-label">è°ƒå‡ºä»“åº“<span class="required">*</span></label>
              <input id="fieldFromStore" type="text" placeholder="å¦‚ï¼šå†…è’™å¤Â·å‘¼å’Œæµ©ç‰¹å¸‚ä¸­å¿ƒä»“" />
            </div>
            <div class="form-field">
              <label class="form-label">è°ƒå…¥ä»“åº“<span class="required">*</span></label>
              <input id="fieldToStore" type="text" placeholder="å¦‚ï¼šå†…è’™å¤Â·åŒ…å¤´å¸‚åˆ†å±€ä»“" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="form-label">åˆ›å»ºäºº / å·¥å·<span class="required">*</span></label>
              <input id="fieldCreator" type="text" value="å¼ ä¸‰ / 1008611" />
            </div>
            <div class="form-field">
              <label class="form-label">è”ç³»ç”µè¯</label>
              <input id="fieldPhone" type="text" placeholder="é€‰å¡«" />
            </div>
          </div>

          <div class="form-field" style="margin-top:4px;">
            <label class="form-label">å¤‡æ³¨è¯´æ˜</label>
            <textarea id="fieldRemark" placeholder="å¦‚ï¼šç”¨äºæŸç‰‡åŒºå…‰çŒ«è°ƒæ‹¨è¡¥è´§"></textarea>
          </div>

          <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="btnSaveBasic" class="btn btn-primary">ä¿å­˜è®¢å•</button>
            <button id="btnResetBasic" class="btn btn-outline">é‡ç½®</button>
          </div>
          <div class="hint" style="margin-top:4px;">
            â€» ä¿å­˜åè§†ä¸ºç”Ÿæˆè°ƒæ‹¨å‡ºå…¥åº“è®¢å•è‰ç¨¿ï¼Œåç»­æ‰«ç è®¾å¤‡ä¸å®¡æ‰¹çŠ¶æ€ä¸æ­¤è®¢å•ç»‘å®šã€‚
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>æ‰«ç æ·»åŠ è®¾å¤‡</span>
            <span style="font-size:11px;color:#2563eb;">å¤šç è¯†åˆ« Â· å…‰æ ‡é€‰é¡¹</span>
          </div>
          <div class="card-subtitle">
            ç‚¹å‡»ã€æ‰«ç æ·»åŠ ã€‘åå¼¹å‡ºæ‰«ç ç•Œé¢ï¼Œé€šè¿‡æ‘„åƒå¤´è¯†åˆ«è®¾å¤‡ä¸Šçš„å¤šä¸ªäºŒç»´ç ã€ä¸€ç»´ç ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªä¸²ç å¹¶åŠ å…¥æœ¬è®¢å•ã€‚
          </div>

          <div style="display:flex; gap:8px; margin-top:4px;">
            <button id="btnOpenScanModal" class="btn btn-primary">ğŸ“· æ‰«ç æ·»åŠ </button>
            <span class="hint" style="align-self:center;">æ”¯æŒè¿ç»­æ‰«ç å¤šå°è®¾å¤‡ï¼Œè‡ªåŠ¨ç´¯è®¡åˆ°è®¾å¤‡æ¸…å•ã€‚</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>æœ¬è®¢å•è®¾å¤‡æ¸…å•</span>
            <span style="font-size:11px;color:#6b7280;">
              å…± <span id="deviceCount">0</span> å°
            </span>
          </div>

          <div id="deviceList" class="device-list">
            <div style="font-size:11px;color:#9ca3af;padding:8px 8px;">
              æš‚æ— è®¾å¤‡ï¼Œè¯·å…ˆç‚¹å‡»ä¸Šæ–¹ã€æ‰«ç æ·»åŠ ã€‘å½•å…¥è®¾å¤‡ã€‚
            </div>
          </div>

          <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="btnGoApprove" class="btn btn-outline">ä¸‹ä¸€æ­¥ï¼šæäº¤å®¡æ‰¹</button>
          </div>
          <div class="hint" style="margin-top:4px;">
            â€» æäº¤å®¡æ‰¹å‰å»ºè®®å®Œæˆæœ¬è®¢å•æ‰€æœ‰è®¾å¤‡çš„æ‰«ç å½•å…¥ã€‚
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>å®¡æ‰¹ä¸ç¡®è®¤</span>
            <span id="approveStatusBadge" class="badge-status badge-draft">è‰ç¨¿</span>
          </div>
          <div class="card-subtitle">
            å‘èµ·å®¡æ‰¹åï¼Œå®¡æ‰¹äººå¯åœ¨æ­¤ç¡®è®¤é€šè¿‡æˆ–é©³å›ï¼Œæµç¨‹ç»“æŸåè®¢å•çŠ¶æ€éšä¹‹æ›´æ–°ã€‚
          </div>

          <div style="display:flex; gap:6px; margin-bottom:6px;">
            <button id="btnSubmitApprove" class="btn btn-primary">ğŸ“¤ æäº¤å®¡æ‰¹</button>
            <button id="btnApprovePass" class="btn btn-outline">âœ… å®¡æ‰¹é€šè¿‡</button>
            <button id="btnApproveReject" class="btn btn-danger">âœ– å®¡æ‰¹é©³å›</button>
          </div>

          <div class="hint">
            â€» å®é™…å®ç°ä¸­ï¼Œæäº¤å®¡æ‰¹åä¼šæµè½¬è‡³å®¡æ‰¹äººç«¯ï¼Œè¿™é‡Œç”¨æŒ‰é’®å¿«é€Ÿæ¼”ç¤ºæµç¨‹å®Œæ•´æ€§ã€‚
          </div>

          <div class="divider"></div>

          <div class="card-subtitle">è®¢å•æµè½¬è®°å½•</div>
          <div id="timeline" class="timeline">
            <div class="timeline-item">ç³»ç»Ÿåˆå§‹åŒ–è®¢å•æµç¨‹</div>
          </div>
        </div>
      </section>

    

        <div class="card">
          <div class="card-header">
            <span>1. æ•…éšœå·¥å•åŸºæœ¬ä¿¡æ¯</span>
            <span id="faultStatusBadge" class="badge-status badge-draft">è‰ç¨¿</span>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">æ•…éšœæ¥æº<span class="required">*</span></label>
              <select id="faultSource">
                <option value="è£…ç»´APPåé¦ˆ">è£…ç»´APPåé¦ˆ</option>
                <option value="å®¢æˆ·æŠ•è¯‰">å®¢æˆ·æŠ•è¯‰</option>
                <option value="è´¨æ£€æŠ½æµ‹">è´¨æ£€æŠ½æµ‹</option>
              </select>
            </div>
            <div class="form-field">
              <label class="form-label">æ•…éšœå·¥å•ç¼–å·</label>
              <input id="faultNo" type="text" placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">æ‰€å±åœ°å¸‚<span class="required">*</span></label>
              <input id="faultCity" type="text" value="å†…è’™å¤Â·å‘¼å’Œæµ©ç‰¹å¸‚" />
            </div>
            <div class="form-field">
              <label class="form-label">æ‰€å±åŒºå¿<span class="required">*</span></label>
              <input id="faultCounty" type="text" value="æ–°åŸåŒº" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">åé¦ˆäºº / å·¥å·<span class="required">*</span></label>
              <input id="faultReporter" type="text" value="æå›› / 1008622" />
            </div>
            <div class="form-field">
              <label class="form-label">è”ç³»ç”µè¯</label>
              <input id="faultPhone" type="text" placeholder="é€‰å¡«" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>2. å…³è”æ•…éšœè®¾å¤‡</span>
            <span style="font-size:11px;color:#2563eb;">æ‰«ç å…³è” Â· ç»ˆç«¯ä¿¡æ¯å›å¡«</span>
          </div>
     

          <div style="display:flex; gap:8px; margin-bottom:6px;">
            <button id="btnOpenFaultScanModal" class="btn btn-primary">ğŸ“· æ‰«ç å…³è”è®¾å¤‡</button>
            <button id="btnClearFaultDevice" class="btn btn-outline">æ¸…é™¤å…³è”è®¾å¤‡</button>
          </div>

          <div class="info-grid">
            <div>
              <div class="info-item-label">è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰</div>
              <div id="faultDevCode" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">ç³»ç»Ÿ SN</div>
              <div id="faultDevSn" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">ç»ˆç«¯ç±»å‹</div>
              <div id="faultDevType" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">å‚å®¶</div>
              <div id="faultDevVendor" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">ç»ˆç«¯å‹å·</div>
              <div id="faultDevModel" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">å…¥åº“æ—¶é—´</div>
              <div id="faultDevInTime" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">è®¾å¤‡çŠ¶æ€</div>
              <div id="faultDevStatus" class="info-item-value">-</div>
            </div>
            <div>
              <div class="info-item-label">åº“å­˜ä½ç½®</div>
              <div id="faultDevLocation" class="info-item-value">-</div>
            </div>
          </div>
          <div class="hint" style="margin-top:4px;">
            â€» è®¾å¤‡ä¿¡æ¯åŸºäºå†…è’™å¤ç»ˆç«¯å°è´¦è‡ªåŠ¨å›å¡«ï¼Œå¯ä½œä¸ºåç»­æ•…éšœåˆ†æä¸é—­ç¯è¿½è¸ªçš„å…³é”®å­—æ®µã€‚
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>3. æ•…éšœè¯¦æƒ…ä¿¡æ¯</span>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">æ•…éšœç±»å‹<span class="required">*</span></label>
              <select id="faultType">
                <option value="è®¾å¤‡æ— æ³•ä¸Šç”µ">è®¾å¤‡æ— æ³•ä¸Šç”µ</option>
                <option value="WiFiä¿¡å·å¼‚å¸¸">WiFiä¿¡å·å¼‚å¸¸</option>
                <option value="ç«¯å£ä¸å¯ç”¨">ç«¯å£ä¸å¯ç”¨</option>
                <option value="é¢‘ç¹æ‰çº¿">é¢‘ç¹æ‰çº¿</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-field">
              <label class="form-label">æ•…éšœç­‰çº§</label>
              <select id="faultLevel">
                <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
                <option value="é‡è¦">é‡è¦</option>
                <option value="ç´§æ€¥">ç´§æ€¥</option>
              </select>
            </div>
          </div>
          <div class="form-field" style="margin-top:4px;">
            <label class="form-label">æ•…éšœç°è±¡æè¿°<span class="required">*</span></label>
            <textarea id="faultDesc" placeholder="å¦‚ï¼šä¸Šç”µåæŒ‡ç¤ºç¯ä¸äº®ï¼Œç”¨æˆ·ç«¯æ— æ³•æ‹¨å·ä¸Šç½‘ã€‚"></textarea>
          </div>
          <div class="form-field" style="margin-top:4px;">
            <label class="form-label">è®¾å¤‡ä½¿ç”¨æƒ…å†µè¯´æ˜</label>
            <textarea id="faultUsage" placeholder="å¦‚ï¼šè®¾å¤‡å·²ä½¿ç”¨ä¸¤å¹´ï¼Œè¿‘æœŸå‡ºç°é—´æ­‡æ€§æ‰çº¿ï¼Œç”¨æˆ·åé¦ˆé¢‘ç¹é‡å¯å¯çŸ­æš‚æ¢å¤ã€‚"></textarea>
          </div>
          <div class="form-field" style="margin-top:4px;">
            <label class="form-label">ä¸Šä¼ æ•…éšœç°è±¡å›¾ç‰‡</label>
            <input id="faultPhotos" type="file" accept="image/*" multiple />
            <div class="hint">â€» å¯æ‹ç…§ä¸Šä¼ æŒ‡ç¤ºç¯çŠ¶æ€ã€å¸ƒçº¿ç¯å¢ƒç­‰å›¾ç‰‡ï¼Œè¾…åŠ©åç»­å¤ç›˜ä¸è´£ä»»ç•Œå®šã€‚</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>4. å·¥å•æäº¤</span>

                    

        
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px;">
            <button id="btnSaveFaultDraft" class="btn btn-primary">ğŸ’¾ ä¿å­˜/æ›´æ–°</button>
            <button id="btnClearFault" class="btn btn-outline">ğŸ—‘ æ¸…ç©ºå·¥å•</button>
            <button id="btnSubmitFault" class="btn btn-danger">ğŸ“¨ æäº¤ç”Ÿæˆæ•…éšœå·¥å•</button>
          </div>
      

          <div class="divider"></div>
          <div class="card-subtitle">æœ€è¿‘åˆ›å»ºçš„æ•…éšœå·¥å•</div>
          <div id="faultList" style="font-size:11px;color:#9ca3af;">
            æš‚æ— æ•…éšœå·¥å•ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹åˆ›å»ºå¹¶æäº¤ã€‚
          </div>
            <!-- æ–°å¢ï¼šæ•…éšœå·¥å•æµè½¬è®°å½• -->
          <div class="divider"></div>
          <div class="card-subtitle">æ•…éšœå·¥å•æµè½¬è®°å½•</div>
          <div id="faultTimeline" class="timeline">
            <div class="timeline-item">ç³»ç»Ÿåˆå§‹åŒ–æ•…éšœå·¥å•æµç¨‹</div>
          </div>

        </div>
      </section>

      <!-- è®¢å•åˆ—è¡¨è§†å›¾ -->
      <section id="view-orders" class="view">
        <div class="card">
          <div class="card-header">
            <span>è°ƒæ‹¨å‡ºå…¥åº“è®¢å•åˆ—è¡¨</span>
            <span style="font-size:11px;color:#6b7280;">æœ€è¿‘æ“ä½œ</span>
          </div>
          <div id="orderList">
            <div style="font-size:11px;color:#9ca3af;">
              æš‚æ— å†å²è®¢å•ï¼Œè¯·å…ˆåœ¨â€œè°ƒæ‹¨å‡ºå…¥åº“â€é¡µåˆ›å»ºå¹¶æ“ä½œä¸€ä¸ªè®¢å•ã€‚
            </div>
          </div>
        </div>
      </section>

      <!-- æˆ‘çš„ -->
      <section id="view-profile" class="view">
        <div class="card">
          <div class="card-header">
            <span>æˆ‘çš„ï¼ˆå ä½ï¼‰</span>
          </div>
          <div style="font-size:12px;color:#6b7280;">
            è¿™é‡Œå¯æ‰©å±•è£…ç»´ä¸ªäººä¿¡æ¯ã€é»˜è®¤è°ƒæ‹¨/æ•…éšœåå¥½é…ç½®ç­‰å†…å®¹ï¼Œå½“å‰ç”¨äºå ä½ã€‚
          </div>
        </div>
      </section>
    </main>

    <!-- é€šç”¨æ‰«ç å¼¹çª—ï¼šè°ƒæ‹¨å‡ºå…¥åº“ / æ•…éšœç»ˆç«¯ å…±ç”¨ -->
    <div id="scanModal" class="modal-backdrop">
      <div class="modal-panel">
        <div class="modal-header">
          <div>
            <div class="modal-title">æ‰«ç è¯†åˆ«ä¸²ç </div>
            <div class="modal-subtitle">å¤šç è¯†åˆ« Â· å…‰æ ‡é€‰é¡¹ Â· ä¸²ç æ¯”å¯¹</div>
          </div>
          <div id="btnCloseScanModal" class="modal-close">âœ•</div>
        </div>

        <div class="camera-box">
          <div class="camera-header-row">
            <span>åç½®æ‘„åƒå¤´ Â· å®æ—¶å–æ™¯</span>
            <span id="cameraStatus">æ‘„åƒå¤´æœªå¼€å¯</span>
          </div>

          <div class="camera-view">
            <video id="cameraVideo" autoplay playsinline muted></video>
            <div class="camera-overlay">
              <div class="corner tl"></div>
              <div class="corner tr"></div>
              <div class="corner bl"></div>
              <div class="corner br"></div>
              <div class="scan-line"></div>
            </div>
            <div id="codeTags" class="code-tags"></div>
          </div>

          <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
            <button id="btnOpenCamera" class="btn btn-primary">ğŸ“· æ‰“å¼€æ‘„åƒå¤´</button>
            <button id="btnStopCamera" class="btn btn-ghost-dark btn" disabled>â–  å…³é—­æ‘„åƒå¤´</button>
       
          </div>

          <div class="camera-summary">
            <div class="camera-summary-block">
              <div class="camera-summary-title">è¯†åˆ«æ‘˜è¦</div>
              <div class="camera-summary-row">
                <span class="key">è¯†åˆ«ç æ•°é‡ï¼š</span>
                <span class="val" id="summaryCount">0</span>
              </div>
              <div class="camera-summary-row">
                <span class="key">äºŒç»´ç  / ä¸€ç»´ç ï¼š</span>
                <span class="val" id="summaryType">-</span>
              </div>
              <div class="camera-summary-row">
                <span class="key">ä¸Šæ¬¡è¯†åˆ«æ—¶é—´ï¼š</span>
                <span class="val" id="summaryTime">-</span>
              </div>
            </div>
            <div class="camera-summary-block">
              <div class="camera-summary-title">å½“å‰å…‰æ ‡ä¸²ç </div>
              <div class="camera-summary-row">
                <span class="key">è®¾å¤‡è¯†åˆ«ç ï¼š</span>
                <span class="val" id="summaryCurrentCode">-</span>
              </div>
              <div class="camera-summary-row">
                <span class="key">ç åˆ¶ç±»å‹ï¼š</span>
                <span class="val" id="summaryCurrentType">-</span>
              </div>
              <div class="camera-summary-row">
                <span class="key">å°è´¦åŒ¹é…ï¼š</span>
                <span class="val" id="summaryCurrentResult">æœªæ¯”å¯¹</span>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:4px;">
            â€» å¤šç æ ‡ç­¾å³ä¸ºâ€œå…‰æ ‡é€‰é¡¹â€ï¼Œç‚¹å‡»æŸä¸ªä¸²ç åè‡ªåŠ¨è§¦å‘å°è´¦æ¯”å¯¹ï¼Œå¯åŠ å…¥è°ƒæ‹¨è®¢å•æˆ–æ•…éšœå·¥å•ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <div class="info-grid">
          <div>
            <div class="info-item-label">è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰</div>
            <div id="infoCode" class="info-item-value">-</div>
          </div>
          <div>
            <div class="info-item-label">ç³»ç»Ÿ SN</div>
            <div id="infoSN" class="info-item-value">-</div>
          </div>
          <div>
            <div class="info-item-label">ç®¡ç†åŸŸ</div>
            <div id="infoDomain" class="info-item-value">-</div>
          </div>
          <div>
            <div class="info-item-label">ç»ˆç«¯ç±»å‹</div>
            <div id="infoType" class="info-item-value">-</div>
          </div>
          <div>
            <div class="info-item-label">ç»ˆç«¯çŠ¶æ€</div>
            <div id="infoStatus" class="info-item-value">-</div>
          </div>
          <div>
            <div class="info-item-label">åº“å­˜ä½ç½®</div>
            <div id="infoLocation" class="info-item-value">-</div>
          </div>
        </div>

        <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
          <button id="btnAddDevice" class="btn btn-primary">â• ç¡®è®¤ä½¿ç”¨å½“å‰ä¸²ç </button>
          <span class="hint">â€» åœ¨å½“å‰åœºæ™¯ä¸­ä½¿ç”¨è¯¥ä¸²ç ï¼Œå¯å†™å…¥è°ƒæ‹¨è®¢å•æˆ–æ•…éšœå·¥å•ã€‚</span>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ Tab -->
    <nav class="tab-bar">
      <div class="tab-item active" data-view="transfer">
        <span class="icon">ğŸ”</span>
        <span>è°ƒæ‹¨å‡ºå…¥åº“</span>
      </div>
      <div class="tab-item" data-view="fault">
        <span class="icon">ğŸ› </span>
        <span>æ•…éšœç»ˆç«¯</span>
      </div>
      <div class="tab-item" data-view="orders">
        <span class="icon">ğŸ“‹</span>
        <span>è®¢å•åˆ—è¡¨</span>
      </div>
      <div class="tab-item" data-view="profile">
        <span class="icon">ğŸ‘¤</span>
        <span>æˆ‘çš„</span>
      </div>
    </nav>
  </div>

  <script>
    // ============== Tab åˆ‡æ¢ ==============
    const tabItems = document.querySelectorAll('.tab-item');
    const views = {
      transfer: document.getElementById('view-transfer'),
      fault: document.getElementById('view-fault'),
      orders: document.getElementById('view-orders'),
      profile: document.getElementById('view-profile')
    };
    const headerTitle = document.getElementById('headerTitle');
    const headerSubTitle = document.getElementById('headerSubTitle');

    const headerTextMap = {
      transfer: {
        title: 'è°ƒæ‹¨å‡ºå…¥åº“',
        sub: 'è®¢å•åˆ›å»º Â· æ‰«ç æ·»åŠ  Â· å®¡æ‰¹ç¡®è®¤'
      },
      fault: {
        title: 'æ•…éšœç»ˆç«¯é—­ç¯ç®¡ç†',
        sub: 'æ•…éšœå·¥å•åˆ›å»º Â· æ‰«ç å…³è”è®¾å¤‡ Â· é—­ç¯ç®¡ç†'
      },
      orders: {
        title: 'è®¢å•åˆ—è¡¨',
        sub: 'æŸ¥è¯¢å†å²è°ƒæ‹¨å‡ºå…¥åº“è®¢å•'
      },
      profile: {
        title: 'æˆ‘çš„',
        sub: 'è£…ç»´ä¿¡æ¯ä¸åå¥½é…ç½®'
      }
    };

    tabItems.forEach(tab => {
      tab.addEventListener('click', () => {
        const viewKey = tab.getAttribute('data-view');

        tabItems.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        Object.keys(views).forEach(key => {
          if (key === viewKey) {
            views[key].classList.add('active', 'fade-in');
          } else {
            views[key].classList.remove('active', 'fade-in');
          }
        });

        headerTitle.textContent = headerTextMap[viewKey].title;
        headerSubTitle.textContent = headerTextMap[viewKey].sub;
      });
    });

    function setStepActive(step) {
      document.querySelectorAll('.step-item').forEach(el => {
        const s = Number(el.getAttribute('data-step'));
        if (s === step) el.classList.add('active');
        else el.classList.remove('active');
      });
    }

    // ============== è°ƒæ‹¨å‡ºå…¥åº“æ•°æ®æ¨¡å‹ ==============
    const orderStatusBadge = document.getElementById('orderStatusBadge');
    const approveStatusBadge = document.getElementById('approveStatusBadge');
    const deviceCountSpan = document.getElementById('deviceCount');
    const deviceListContainer = document.getElementById('deviceList');
    const timelineEl = document.getElementById('timeline');
    const orderListEl = document.getElementById('orderList');

    const fieldOrderType = document.getElementById('fieldOrderType');
    const fieldOrderNo   = document.getElementById('fieldOrderNo');
    const fieldFromStore = document.getElementById('fieldFromStore');
    const fieldToStore   = document.getElementById('fieldToStore');
    const fieldCreator   = document.getElementById('fieldCreator');
    const fieldPhone     = document.getElementById('fieldPhone');
    const fieldRemark    = document.getElementById('fieldRemark');

    const btnSaveBasic   = document.getElementById('btnSaveBasic');
    const btnResetBasic  = document.getElementById('btnResetBasic');
    const btnGoApprove   = document.getElementById('btnGoApprove');
    const btnSubmitApprove = document.getElementById('btnSubmitApprove');
    const btnApprovePass   = document.getElementById('btnApprovePass');
    const btnApproveReject = document.getElementById('btnApproveReject');

    let currentOrder = null;
    let orderHistory = [];

    function generateOrderNo() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const t = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
      return 'DBDD' + y + m + d + t;
    }

    function generateFaultNo() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const t = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
      return 'GZGD' + y + m + d + t;
    }

    function setOrderStatus(status) {
      orderStatusBadge.textContent = status;
      approveStatusBadge.textContent = status;
      orderStatusBadge.className = 'badge-status';
      approveStatusBadge.className = 'badge-status';
      if (status === 'è‰ç¨¿') {
        orderStatusBadge.classList.add('badge-draft');
        approveStatusBadge.classList.add('badge-draft');
      } else if (status === 'å¾…å®¡æ‰¹') {
        orderStatusBadge.classList.add('badge-pending');
        approveStatusBadge.classList.add('badge-pending');
      } else if (status === 'å·²é€šè¿‡') {
        orderStatusBadge.classList.add('badge-pass');
        approveStatusBadge.classList.add('badge-pass');
      } else if (status === 'å·²é©³å›') {
        orderStatusBadge.classList.add('badge-reject');
        approveStatusBadge.classList.add('badge-reject');
      }
    }

    function appendTimeline(text) {
      const item = document.createElement('div');
      item.className = 'timeline-item';
      const nowStr = new Date().toLocaleString();
      item.textContent = nowStr + ' - ' + text;
      timelineEl.appendChild(item);
      timelineEl.scrollTop = timelineEl.scrollHeight;
    }

    function saveBasicInfo() {
      const orderType = fieldOrderType.value;
      const fromStore = fieldFromStore.value.trim();
      const toStore   = fieldToStore.value.trim();
      const creator   = fieldCreator.value.trim();
      const phone     = fieldPhone.value.trim();
      const remark    = fieldRemark.value.trim();

      if (!fromStore || !toStore || !creator) {
        alert('è°ƒå‡ºä»“åº“ã€è°ƒå…¥ä»“åº“ã€åˆ›å»ºäºº/å·¥å·ä¸ºå¿…å¡«é¡¹ã€‚');
        return;
      }

      if (!currentOrder) {
        const orderNo = generateOrderNo();
        fieldOrderNo.value = orderNo;
        currentOrder = {
          orderNo,
          type: orderType,
          fromStore,
          toStore,
          creator,
          phone,
          remark,
          devices: [],
          status: 'è‰ç¨¿',
          createdAt: new Date().toISOString()
        };
        appendTimeline('åˆ›å»ºè®¢å•è‰ç¨¿ï¼š' + orderNo);
      } else {
        currentOrder.type = orderType;
        currentOrder.fromStore = fromStore;
        currentOrder.toStore = toStore;
        currentOrder.creator = creator;
        currentOrder.phone = phone;
        currentOrder.remark = remark;
        appendTimeline('æ›´æ–°è®¢å•åŸºæœ¬ä¿¡æ¯');
      }

      setOrderStatus('è‰ç¨¿');
      setStepActive(2);
      alert('è®¢å•åŸºæœ¬ä¿¡æ¯å·²ä¿å­˜ï¼Œå¯ä»¥ç‚¹å‡»ã€æ‰«ç æ·»åŠ ã€‘å½•å…¥è®¾å¤‡ã€‚');

      const idx = orderHistory.findIndex(o => o.orderNo === currentOrder.orderNo);
      if (idx === -1) orderHistory.unshift({ ...currentOrder });
      else orderHistory[idx] = { ...currentOrder };
      renderOrderList();
    }

    function resetBasicInfo() {
      fieldOrderType.value = 'è°ƒæ‹¨å‡ºåº“';
      fieldOrderNo.value = '';
      fieldFromStore.value = '';
      fieldToStore.value = '';
      fieldCreator.value = 'å¼ ä¸‰ / 1008611';
      fieldPhone.value = '';
      fieldRemark.value = '';
      currentOrder = null;
      setOrderStatus('è‰ç¨¿');
      setStepActive(1);
      timelineEl.innerHTML = '<div class="timeline-item">ç³»ç»Ÿåˆå§‹åŒ–è®¢å•æµç¨‹</div>';
      renderDeviceList();
    }

    btnSaveBasic.addEventListener('click', saveBasicInfo);
    btnResetBasic.addEventListener('click', resetBasicInfo);

    // ============== å†…è’™å¤ç»ˆç«¯å°è´¦æ ·ä¾‹ ==============
    const innerMongoliaRecord = {
      sn: 'SKYWA8EFF0AD',
      domain: 'å†…è’™å¤è‡ªæ²»åŒºÂ·å‘¼å’Œæµ©ç‰¹å¸‚æ–°åŸåŒº',
      type: 'å…‰çŒ«-å®¶åº­ç½‘å…³',
      status: 'åœ¨åº“',
      location: 'å†…è’™å¤Â·å‘¼å’Œæµ©ç‰¹å¸‚æ–°åŸåŒºç®¡ç†åŸŸä»“åº“',
      vendor: 'NMTY',
      model: 'TEWA-7100A',
      inTime: '2024-10-18 09:30'
    };

    const terminalCatalog = {
      "SN1234567890": {
        sn: "SN1234567890",
        domain: "å†…è’™å¤è‡ªæ²»åŒºÂ·åŒ…å¤´å¸‚æ˜†éƒ½ä»‘åŒº",
        type: "å…‰çŒ«",
        status: "åœ¨åº“",
        location: "å†…è’™å¤Â·åŒ…å¤´å¸‚æ˜†éƒ½ä»‘åŒºä¸­å¿ƒä»“",
        vendor: "æ¼”ç¤ºå‚å®¶A",
        model: "MODEL-A1",
        inTime: "2024-03-01 10:00"
      }
    };

    // ============== æ‰«ç å¼¹çª—å¼€å…³ =====================
    const scanModal = document.getElementById('scanModal');
    const btnOpenScanModal = document.getElementById('btnOpenScanModal');
    const btnCloseScanModal = document.getElementById('btnCloseScanModal');

    let scanContext = 'transfer'; // transfer | fault

    btnOpenScanModal.addEventListener('click', () => {
      if (!currentOrder) {
        alert('è¯·å…ˆä¿å­˜è®¢å•åŸºæœ¬ä¿¡æ¯ï¼Œå†è¿›è¡Œæ‰«ç ã€‚');
        return;
      }
      scanContext = 'transfer';
      scanModal.classList.add('active');
      setStepActive(2);
    });

    btnCloseScanModal.addEventListener('click', () => {
      scanModal.classList.remove('active');
    });

    scanModal.addEventListener('click', (e) => {
      if (e.target === scanModal) {
        scanModal.classList.remove('active');
      }
    });

    // ============== æ‘„åƒå¤´ & å¤šç è¯†åˆ«ï¼ˆå›ºå®šä¸€ç»´ç  + äºŒç»´ç ï¼‰ ==============
    const mockRecognizedCodes = [
      { code: "SKYWA8EFF0AD", type: "ä¸€ç»´ç " },
      { code: "ssid1=None&wifipwd=None&username=user&userpwd=jnh6@9Xe&model=model18&sn=SKYWA8EFF0AD&ip=192.168.1.1&vendor=NMTY&productname=TEWA-7100A&date=202410&lanability=GE,GE,GE,GE", type: "äºŒç»´ç " }
    ];



      const cameraVideo = document.getElementById('cameraVideo');
const cameraStatus = document.getElementById('cameraStatus');
const btnOpenCamera = document.getElementById('btnOpenCamera');
const btnStopCamera = document.getElementById('btnStopCamera');
const btnMockScan = document.getElementById('btnMockScan'); // å¦‚æœé¡µé¢æ²¡è¿™ä¸ªæŒ‰é’®ï¼Œä¹Ÿæ²¡å…³ç³»
const codeTagsContainer = document.getElementById('codeTags');

const summaryCount = document.getElementById('summaryCount');
const summaryType = document.getElementById('summaryType');
const summaryTime = document.getElementById('summaryTime');
const summaryCurrentCode = document.getElementById('summaryCurrentCode');
const summaryCurrentType = document.getElementById('summaryCurrentType');
const summaryCurrentResult = document.getElementById('summaryCurrentResult');

const infoCode = document.getElementById('infoCode');
const infoSN = document.getElementById('infoSN');
const infoDomain = document.getElementById('infoDomain');
const infoType = document.getElementById('infoType');
const infoStatus = document.getElementById('infoStatus');
const infoLocation = document.getElementById('infoLocation');

let currentStream = null;
let currentCode = null;
let currentSelectedItem = null;

// æ‰“å¼€æ‘„åƒå¤´
btnOpenCamera.addEventListener('click', async () => {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è°ƒç”¨ï¼Œè¯·åœ¨å®‰å“æ‰‹æœºæµè§ˆå™¨æˆ– HTTPS ç¯å¢ƒä¸‹è®¿é—®ã€‚');
      return;
    }
    currentStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    cameraVideo.srcObject = currentStream;
    cameraStatus.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
    btnOpenCamera.disabled = true;
    btnStopCamera.disabled = false;

    // æ‰“å¼€æ‘„åƒå¤´ 2 ç§’åè‡ªåŠ¨å‡ºç°ä¸€ç»´ç  + äºŒç»´ç ï¼ˆæ¨¡æ‹Ÿè¯†åˆ«ï¼‰
    setTimeout(() => {
      renderCodeTags(mockRecognizedCodes);
      const first = mockRecognizedCodes[0];
      if (first) {
        const firstTag = document.querySelector('.code-tag[data-index="0"]');
        if (firstTag) firstTag.classList.add('active');
        onCodeSelected(first);
      }
    }, 2000);
  } catch (e) {
    console.error(e);
    alert('æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼š' + e.message);
  }
});

// å…³é—­æ‘„åƒå¤´
btnStopCamera.addEventListener('click', () => {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
    currentStream = null;
  }
  cameraVideo.srcObject = null;
  cameraStatus.textContent = 'æ‘„åƒå¤´æœªå¼€å¯';
  btnOpenCamera.disabled = false;
  btnStopCamera.disabled = true;
});

// ï¼ˆå¯é€‰ï¼‰æ¨¡æ‹Ÿæ‰«ç æŒ‰é’®ï¼Œä»…å½“é¡µé¢ä¸ŠçœŸçš„æœ‰è¿™ä¸ªæŒ‰é’®æ—¶æ‰ç”Ÿæ•ˆ
if (btnMockScan) {
  btnMockScan.addEventListener('click', () => {
    renderCodeTags(mockRecognizedCodes);
    const first = mockRecognizedCodes[0];
    if (first) {
      const firstTag = document.querySelector('.code-tag[data-index="0"]');
      if (firstTag) firstTag.classList.add('active');
      onCodeSelected(first);
    }
  });
}


    btnOpenCamera.addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è°ƒç”¨ï¼Œè¯·åœ¨å®‰å“æ‰‹æœºæµè§ˆå™¨æˆ– HTTPS ç¯å¢ƒä¸‹è®¿é—®ã€‚');
          return;
        }
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        cameraVideo.srcObject = currentStream;
        cameraStatus.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
        btnOpenCamera.disabled = true;
        btnStopCamera.disabled = false;

        // æ‰“å¼€æ‘„åƒå¤´ 2 ç§’åè‡ªåŠ¨å‡ºç°ä¸€ç»´ç  + äºŒç»´ç 
        setTimeout(() => {
          renderCodeTags(mockRecognizedCodes);
          const first = mockRecognizedCodes[0];
          if (first) {
            const firstTag = document.querySelector('.code-tag[data-index="0"]');
            if (firstTag) firstTag.classList.add('active');
            onCodeSelected(first);
          }
        }, 2000);
      } catch (e) {
        console.error(e);
        alert('æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼š' + e.message);
      }
    });

    btnStopCamera.addEventListener('click', () => {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      cameraVideo.srcObject = null;
      cameraStatus.textContent = 'æ‘„åƒå¤´æœªå¼€å¯';
      btnOpenCamera.disabled = false;
      btnStopCamera.disabled = true;
    });

    function renderCodeTags(codes) {
      codeTagsContainer.innerHTML = '';
      if (!codes || !codes.length) {
        const span = document.createElement('span');
        span.style.fontSize = '10px';
        span.style.color = '#9ca3af';
      
        codeTagsContainer.appendChild(span);
        summaryCount.textContent = '0';
        summaryType.textContent = '-';
        summaryTime.textContent = '-';
        return;
      }
      let typeSet = new Set();
      codes.forEach((item, idx) => {
        typeSet.add(item.type);
        const tag = document.createElement('div');
        tag.className = 'code-tag';
        tag.dataset.index = idx;

        const typeSpan = document.createElement('span');
        typeSpan.className = 'code-tag-type';
        typeSpan.textContent = item.type;

        const textSpan = document.createElement('span');
        textSpan.textContent = item.code;

        tag.appendChild(typeSpan);
        tag.appendChild(textSpan);

        tag.addEventListener('click', () => {
          document.querySelectorAll('.code-tag').forEach(el => el.classList.remove('active'));
          tag.classList.add('active');
          onCodeSelected(item);
        });

        codeTagsContainer.appendChild(tag);
      });

      summaryCount.textContent = String(codes.length);
      summaryType.textContent = Array.from(typeSet).join(' / ');
      summaryTime.textContent = new Date().toLocaleString();
    }

 

    function onCodeSelected(item) {
      currentCode = item.code;
      currentSelectedItem = item;
      summaryCurrentCode.textContent = item.code;
      summaryCurrentType.textContent = item.type;

      let record = null;
      if (item.code === 'SKYWA8EFF0AD' || item.code.indexOf('sn=SKYWA8EFF0AD') > -1) {
        record = innerMongoliaRecord;
      } else if (terminalCatalog[item.code]) {
        record = terminalCatalog[item.code];
      }

      if (record) {
        infoCode.textContent = item.code;
        infoSN.textContent = record.sn;
        infoDomain.textContent = record.domain;
        infoType.textContent = record.type;
        infoStatus.textContent = record.status;
        infoLocation.textContent = record.location;

        infoSN.className = 'info-item-value good';
        infoDomain.className = 'info-item-value good';
        infoType.className = 'info-item-value good';
        infoStatus.className = 'info-item-value good';
        infoLocation.className = 'info-item-value good';

        summaryCurrentResult.textContent = 'å·²æ‰¾åˆ°ç³»ç»Ÿç»ˆç«¯å°è´¦è®°å½•';
        summaryCurrentResult.className = 'good';
      } else {
        infoCode.textContent = item.code;
        infoSN.textContent = 'ç³»ç»Ÿæ— è®°å½•';
        infoDomain.textContent = 'ç³»ç»Ÿæ— è®°å½•';
        infoType.textContent = 'ç³»ç»Ÿæ— è®°å½•';
        infoStatus.textContent = 'ç³»ç»Ÿæ— è®°å½•';
        infoLocation.textContent = 'ç³»ç»Ÿæ— è®°å½•';

        infoSN.className = 'info-item-value bad';
        infoDomain.className = 'info-item-value bad';
        infoType.className = 'info-item-value bad';
        infoStatus.className = 'info-item-value bad';
        infoLocation.className = 'info-item-value bad';

        summaryCurrentResult.textContent = 'æœªåœ¨ç³»ç»Ÿå°è´¦ä¸­æ‰¾åˆ°è¯¥ä¸²ç ';
        summaryCurrentResult.className = 'bad';
      }
    }

    // ============== è®¾å¤‡æ¸…å•æ“ä½œï¼ˆè°ƒæ‹¨ï¼‰ ==============
    const btnAddDevice = document.getElementById('btnAddDevice');

    function renderDeviceList() {
      deviceListContainer.innerHTML = '';
      if (!currentOrder || !currentOrder.devices.length) {
        const div = document.createElement('div');
        div.style.fontSize = '11px';
        div.style.color = '#9ca3af';
        div.style.padding = '8px 8px';
        div.textContent = 'æš‚æ— è®¾å¤‡ï¼Œè¯·å…ˆç‚¹å‡»ä¸Šæ–¹ã€æ‰«ç æ·»åŠ ã€‘å½•å…¥è®¾å¤‡ã€‚';
        deviceListContainer.appendChild(div);
        deviceCountSpan.textContent = '0';
        return;
      }
      deviceCountSpan.textContent = String(currentOrder.devices.length);

      currentOrder.devices.forEach((dev, index) => {
        const row = document.createElement('div');
        row.className = 'device-row';

        const meta = document.createElement('div');
        meta.className = 'device-meta';

        const line1 = document.createElement('div');
        line1.className = 'device-meta-line';
        line1.textContent = dev.code + ' | ' + dev.type;

        const line2 = document.createElement('div');
        line2.className = 'device-meta-line';
        line2.style.fontSize = '10px';
        line2.style.color = '#6b7280';
        line2.textContent = dev.domain + ' Â· ' + dev.status;

        const line3 = document.createElement('div');
        line3.className = 'device-meta-line';
        line3.style.fontSize = '10px';
        line3.style.color = '#9ca3af';
        line3.textContent = dev.location;

        meta.appendChild(line1);
        meta.appendChild(line2);
        meta.appendChild(line3);

        const actionBtn = document.createElement('button');
        actionBtn.className = 'btn btn-outline';
        actionBtn.style.fontSize = '10px';
        actionBtn.textContent = 'ç§»é™¤';
        actionBtn.addEventListener('click', () => {
          currentOrder.devices.splice(index, 1);
          appendTimeline('ç§»é™¤è®¾å¤‡ï¼š' + dev.code);
          renderDeviceList();
        });

        row.appendChild(meta);
        row.appendChild(actionBtn);
        deviceListContainer.appendChild(row);
      });
    }

    // ============== æ•…éšœç»ˆç«¯é—­ç¯ç®¡ç†ï¼šæ•°æ®ä¸äº¤äº’ ==============
    const faultStatusBadge = document.getElementById('faultStatusBadge');
    const faultNoInput     = document.getElementById('faultNo');
    const faultSource      = document.getElementById('faultSource');
    const faultCity        = document.getElementById('faultCity');
    const faultCounty      = document.getElementById('faultCounty');
    const faultReporter    = document.getElementById('faultReporter');
    const faultPhone       = document.getElementById('faultPhone');
    const faultType        = document.getElementById('faultType');
    const faultLevel       = document.getElementById('faultLevel');
    const faultDesc        = document.getElementById('faultDesc');
    const faultUsage       = document.getElementById('faultUsage');
    const faultPhotos      = document.getElementById('faultPhotos');

    const faultDevCode     = document.getElementById('faultDevCode');
    const faultDevSn       = document.getElementById('faultDevSn');
    const faultDevType     = document.getElementById('faultDevType');
    const faultDevVendor   = document.getElementById('faultDevVendor');
    const faultDevModel    = document.getElementById('faultDevModel');
    const faultDevInTime   = document.getElementById('faultDevInTime');
    const faultDevStatus   = document.getElementById('faultDevStatus');
    const faultDevLocation = document.getElementById('faultDevLocation');

    const btnOpenFaultScanModal = document.getElementById('btnOpenFaultScanModal');
    const btnClearFaultDevice   = document.getElementById('btnClearFaultDevice');
    const btnSaveFaultDraft     = document.getElementById('btnSaveFaultDraft');
    const btnClearFault         = document.getElementById('btnClearFault');
    const btnSubmitFault        = document.getElementById('btnSubmitFault');
       const faultListEl           = document.getElementById('faultList');
    const faultTimelineEl       = document.getElementById('faultTimeline'); // æ–°å¢


    let currentFaultTicket = null;
    let faultTickets = [];

    function setFaultStatus(status) {
      faultStatusBadge.textContent = status;
      faultStatusBadge.className = 'badge-status';
      if (status === 'è‰ç¨¿') faultStatusBadge.classList.add('badge-draft');
      else if (status === 'å·²æäº¤') faultStatusBadge.classList.add('badge-pass');
    }

    function clearFaultDeviceView() {
      faultDevCode.textContent = '-';
      faultDevSn.textContent = '-';
      faultDevType.textContent = '-';
      faultDevVendor.textContent = '-';
      faultDevModel.textContent = '-';
      faultDevInTime.textContent = '-';
      faultDevStatus.textContent = '-';
      faultDevLocation.textContent = '-';
    }

    function resetFaultForm() {
      faultNoInput.value = '';
      faultSource.value = 'è£…ç»´APPåé¦ˆ';
      faultCity.value = 'å†…è’™å¤Â·å‘¼å’Œæµ©ç‰¹å¸‚';
      faultCounty.value = 'æ–°åŸåŒº';
      faultReporter.value = 'æå›› / 1008622';
      faultPhone.value = '';
      faultType.value = 'è®¾å¤‡æ— æ³•ä¸Šç”µ';
      faultLevel.value = 'ä¸€èˆ¬';
      faultDesc.value = '';
      faultUsage.value = '';
      faultPhotos.value = '';
      clearFaultDeviceView();
      currentFaultTicket = null;
      setFaultStatus('è‰ç¨¿');
      if (faultTimelineEl) {
        faultTimelineEl.innerHTML = '<div class="timeline-item">ç³»ç»Ÿåˆå§‹åŒ–æ•…éšœå·¥å•æµç¨‹</div>';
      }
    }
    // æ–°å¢ï¼šæ•…éšœå·¥å•æµè½¬è®°å½•è¿½åŠ 
    function appendFaultTimeline(text) {
      if (!faultTimelineEl) return;
      const item = document.createElement('div');
      item.className = 'timeline-item';
      const nowStr = new Date().toLocaleString();
      item.textContent = nowStr + ' - ' + text;
      faultTimelineEl.appendChild(item);
      faultTimelineEl.scrollTop = faultTimelineEl.scrollHeight;
    }


    
    function saveFaultDraft() {
      const city = faultCity.value.trim();
      const county = faultCounty.value.trim();
      const reporter = faultReporter.value.trim();
      const desc = faultDesc.value.trim();

      if (!city || !county || !reporter || !desc) {
        alert('æ‰€å±åœ°å¸‚ã€æ‰€å±åŒºå¿ã€åé¦ˆäºº/å·¥å·ã€æ•…éšœç°è±¡æè¿°ä¸ºå¿…å¡«é¡¹ã€‚');
        return;
      }

      if (!currentFaultTicket) {
        const faultNo = generateFaultNo();
        faultNoInput.value = faultNo;
        currentFaultTicket = {
          faultNo,
          status: 'è‰ç¨¿',
          basic: {},
          device: null,
          detail: {}
        };
         appendFaultTimeline('åˆ›å»ºæ•…éšœå·¥å•è‰ç¨¿ï¼š' + faultNo);   // â˜… æ–°å¢
      }

      currentFaultTicket.basic = {
        source: faultSource.value,
        city: faultCity.value.trim(),
        county: faultCounty.value.trim(),
        reporter: faultReporter.value.trim(),
        phone: faultPhone.value.trim()
      };

      currentFaultTicket.detail = {
        type: faultType.value,
        level: faultLevel.value,
        desc: faultDesc.value.trim(),
        usage: faultUsage.value.trim(),
        photoCount: faultPhotos.files ? faultPhotos.files.length : 0
      };

      // è®¾å¤‡ä¿¡æ¯
      if (faultDevSn.textContent !== '-' && faultDevSn.textContent.trim() !== '') {
        currentFaultTicket.device = {
          code: faultDevCode.textContent,
          sn: faultDevSn.textContent,
          type: faultDevType.textContent,
          vendor: faultDevVendor.textContent,
          model: faultDevModel.textContent,
          inTime: faultDevInTime.textContent,
          status: faultDevStatus.textContent,
          location: faultDevLocation.textContent
        };
      }

      setFaultStatus('è‰ç¨¿');
      appendFaultTimeline('ä¿å­˜/æ›´æ–°æ•…éšœå·¥å•è‰ç¨¿');           // â˜… æ–°å¢
      alert('æ•…éšœå·¥å•è‰ç¨¿å·²ä¿å­˜ï¼Œå¯ç»§ç»­è¡¥å……æˆ–ä¿®æ”¹åå†æäº¤ã€‚');
      renderFaultList();
    }

    function renderFaultList() {
      faultListEl.innerHTML = '';
      if (!faultTickets.length && !currentFaultTicket) {
        faultListEl.style.color = '#9ca3af';
        faultListEl.textContent = 'æš‚æ— æ•…éšœå·¥å•ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹åˆ›å»ºå¹¶æäº¤ã€‚';
        return;
      }
      const tickets = [...faultTickets];
      if (currentFaultTicket && !faultTickets.find(t => t.faultNo === currentFaultTicket.faultNo)) {
        tickets.unshift(currentFaultTicket);
      }
      tickets.forEach(t => {
        const div = document.createElement('div');
        div.className = 'order-item';
        const header = document.createElement('div');
        header.className = 'order-header';
        const title = document.createElement('div');
        title.className = 'order-title';
        title.textContent = t.faultNo;
        const statusSpan = document.createElement('span');
        statusSpan.className = 'badge-status';
        statusSpan.textContent = t.status;
        if (t.status === 'è‰ç¨¿') statusSpan.classList.add('badge-draft');
        if (t.status === 'å·²æäº¤') statusSpan.classList.add('badge-pass');
        header.appendChild(title);
        header.appendChild(statusSpan);

        const meta1 = document.createElement('div');
        meta1.className = 'order-meta';
        const left1 = document.createElement('span');
        left1.textContent = (t.detail?.type || 'æœªçŸ¥') + ' | ' + (t.device?.type || 'æœªå…³è”ç»ˆç«¯');
        const right1 = document.createElement('span');
        right1.textContent = t.basic?.city + ' Â· ' + t.basic?.county;
        meta1.appendChild(left1);
        meta1.appendChild(right1);

        const meta2 = document.createElement('div');
        meta2.className = 'order-meta';
        const left2 = document.createElement('span');
        left2.textContent = 'åé¦ˆäººï¼š' + (t.basic?.reporter || '');
        const right2 = document.createElement('span');
        right2.textContent = t.device?.sn || 'æ—  SN';
        meta2.appendChild(left2);
        meta2.appendChild(right2);

        div.appendChild(header);
        div.appendChild(meta1);
        div.appendChild(meta2);

        // ä»…å¯¹è‰ç¨¿æ”¯æŒå›å¡«
        if (t.status === 'è‰ç¨¿') {
          const tagRow = document.createElement('div');
          tagRow.style.marginTop = '4px';
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = 'ç‚¹å‡»å›å¡«åˆ°ä¸Šæ–¹è¿›è¡Œä¿®æ”¹';
          tagRow.appendChild(tag);
          div.appendChild(tagRow);

          div.addEventListener('click', () => {
            currentFaultTicket = { ...t };
            faultNoInput.value = t.faultNo;
            faultSource.value = t.basic.source;
            faultCity.value = t.basic.city;
            faultCounty.value = t.basic.county;
            faultReporter.value = t.basic.reporter;
            faultPhone.value = t.basic.phone || '';

            faultType.value = t.detail.type;
            faultLevel.value = t.detail.level || 'ä¸€èˆ¬';
            faultDesc.value = t.detail.desc;
            faultUsage.value = t.detail.usage || '';
            setFaultStatus(t.status);

            if (t.device) {
              faultDevCode.textContent = t.device.code;
              faultDevSn.textContent = t.device.sn;
              faultDevType.textContent = t.device.type;
              faultDevVendor.textContent = t.device.vendor;
              faultDevModel.textContent = t.device.model;
              faultDevInTime.textContent = t.device.inTime;
              faultDevStatus.textContent = t.device.status;
              faultDevLocation.textContent = t.device.location;
            } else {
              clearFaultDeviceView();
            }
          });
        }

        faultListEl.appendChild(div);
      });
    }

    btnSaveFaultDraft.addEventListener('click', saveFaultDraft);
    btnClearFault.addEventListener('click', () => {
      if (confirm('ç¡®è®¤åˆ é™¤å½“å‰æ•…éšœå·¥å•è‰ç¨¿ï¼Ÿ')) {
        if (currentFaultTicket) {
          faultTickets = faultTickets.filter(t => t.faultNo !== currentFaultTicket.faultNo);
        }
        resetFaultForm();
        renderFaultList();
      }
    });

    btnSubmitFault.addEventListener('click', () => {
      if (!currentFaultTicket) {
        alert('è¯·å…ˆä¿å­˜ä¸€æ¬¡æ•…éšœå·¥å•è‰ç¨¿ï¼Œå†æäº¤ã€‚');
        return;
      }
      saveFaultDraft(); // ç¡®ä¿æœ€æ–°å†…å®¹å†™å…¥
      currentFaultTicket.status = 'å·²æäº¤';
      setFaultStatus('å·²æäº¤');
            appendFaultTimeline('æäº¤ç”Ÿæˆæ•…éšœå·¥å•ï¼š' + currentFaultTicket.faultNo); // â˜… æ–°å¢

      faultTickets = faultTickets.filter(t => t.faultNo !== currentFaultTicket.faultNo);
      faultTickets.unshift({ ...currentFaultTicket });
      alert('æ•…éšœå·¥å•å·²æäº¤ï¼Œåç»­å¯åœ¨åå°è¿›è¡Œæ´¾å•å¤„ç†ä¸é—­ç¯è·Ÿè¸ªã€‚');
      renderFaultList();
    });

    btnClearFaultDevice.addEventListener('click', () => {
      clearFaultDeviceView();
      if (currentFaultTicket) currentFaultTicket.device = null;
    });

    btnOpenFaultScanModal.addEventListener('click', () => {
      scanContext = 'fault';
      scanModal.classList.add('active');
    });

    // ============== å°†å½“å‰ä¸²ç å†™å…¥ä¸åŒåœºæ™¯ ==============
    btnAddDevice.addEventListener('click', () => {
      if (!currentSelectedItem || !currentCode) {
        alert('è¯·å…ˆåœ¨è¯†åˆ«æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªå…‰æ ‡ä¸²ç ã€‚');
        return;
      }
      let record = null;
      if (currentCode === 'SKYWA8EFF0AD' || currentCode.indexOf('sn=SKYWA8EFF0AD') > -1) {
        record = innerMongoliaRecord;
      } else if (terminalCatalog[currentCode]) {
        record = terminalCatalog[currentCode];
      } else {
        record = {
          sn: currentCode,
          domain: 'ç³»ç»Ÿæ— è®°å½•',
          type: 'æœªçŸ¥',
          status: 'æœªçŸ¥',
          location: 'æœªçŸ¥',
          vendor: 'æœªçŸ¥',
          model: 'æœªçŸ¥',
          inTime: '-'
        };
      }

      if (scanContext === 'transfer') {
        if (!currentOrder) {
          alert('è¯·å…ˆä¿å­˜è®¢å•åŸºæœ¬ä¿¡æ¯ã€‚');
          return;
        }
        const exists = currentOrder.devices.some(d => d.code === currentCode);
        if (exists) {
          alert('è¯¥è®¾å¤‡å·²åœ¨æœ¬è®¢å•æ¸…å•ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ ã€‚');
          return;
        }
        currentOrder.devices.push({
          code: currentCode,
          sn: record.sn,
          domain: record.domain,
          type: record.type,
          status: record.status,
          location: record.location
        });
        appendTimeline('æ‰«ç å¹¶åŠ å…¥è®¾å¤‡ï¼š' + currentCode);

        const idx = orderHistory.findIndex(o => o.orderNo === currentOrder.orderNo);
        if (idx === -1) orderHistory.unshift({ ...currentOrder });
        else orderHistory[idx] = { ...currentOrder };
        renderDeviceList();
        renderOrderList();
        scanModal.classList.remove('active');
      } else if (scanContext === 'fault') {
        // å†™å…¥æ•…éšœå·¥å•çš„å…³è”è®¾å¤‡ä¿¡æ¯
        faultDevCode.textContent = currentCode;
        faultDevSn.textContent = record.sn;
        faultDevType.textContent = record.type;
        faultDevVendor.textContent = record.vendor || 'NMTY';
        faultDevModel.textContent = record.model || 'TEWA-7100A';
        faultDevInTime.textContent = record.inTime || '2024-10';
        faultDevStatus.textContent = record.status;
        faultDevLocation.textContent = record.location;
        if (!currentFaultTicket) {
          const faultNo = generateFaultNo();
          faultNoInput.value = faultNo;
          currentFaultTicket = {
            faultNo,
            status: 'è‰ç¨¿',
            basic: {},
            device: null,
            detail: {}
          };
        }
        currentFaultTicket.device = {
          code: currentCode,
          sn: record.sn,
          type: record.type,
          vendor: record.vendor || 'NMTY',
          model: record.model || 'TEWA-7100A',
          inTime: record.inTime || '2024-10',
          status: record.status,
          location: record.location
        };
        scanModal.classList.remove('active');
      }
    });

    // ============== å®¡æ‰¹æ¨¡æ‹Ÿ ==============
    btnGoApprove.addEventListener('click', () => {
      if (!currentOrder) {
        alert('è¯·å…ˆä¿å­˜è®¢å•åŸºæœ¬ä¿¡æ¯ã€‚');
        return;
      }
      if (!currentOrder.devices.length) {
        if (!confirm('å½“å‰è®¢å•è®¾å¤‡æ¸…å•ä¸ºç©ºï¼Œç¡®å®šè¦ç›´æ¥è¿›å…¥å®¡æ‰¹ç¯èŠ‚å—ï¼Ÿ')) return;
      }
      setStepActive(3);
      appendTimeline('è¿›å…¥å®¡æ‰¹ç¡®è®¤ç¯èŠ‚');
    });

    btnSubmitApprove.addEventListener('click', () => {
      if (!currentOrder) {
        alert('è¯·å…ˆå®Œæˆè®¢å•åŸºæœ¬ä¿¡æ¯å¹¶è‡³å°‘ä¿å­˜ä¸€æ¬¡ã€‚');
        return;
      }
      setOrderStatus('å¾…å®¡æ‰¹');
      currentOrder.status = 'å¾…å®¡æ‰¹';
      appendTimeline('æäº¤å®¡æ‰¹');
      const idx = orderHistory.findIndex(o => o.orderNo === currentOrder.orderNo);
      if (idx === -1) orderHistory.unshift({ ...currentOrder });
      else orderHistory[idx] = { ...currentOrder };
      renderOrderList();
    });

    btnApprovePass.addEventListener('click', () => {
      if (!currentOrder || currentOrder.status !== 'å¾…å®¡æ‰¹') {
        alert('å½“å‰è®¢å•å°šæœªå¤„äºâ€œå¾…å®¡æ‰¹â€çŠ¶æ€ï¼Œæ— æ³•æ‰§è¡Œå®¡æ‰¹é€šè¿‡æ¼”ç¤ºã€‚');
        return;
      }
      setOrderStatus('å·²é€šè¿‡');
      currentOrder.status = 'å·²é€šè¿‡';
      appendTimeline('å®¡æ‰¹é€šè¿‡ï¼Œè®¢å•æµç¨‹å®Œæˆ');
      const idx = orderHistory.findIndex(o => o.orderNo === currentOrder.orderNo);
      if (idx === -1) orderHistory.unshift({ ...currentOrder });
      else orderHistory[idx] = { ...currentOrder };
      renderOrderList();
    });

    btnApproveReject.addEventListener('click', () => {
      if (!currentOrder || currentOrder.status !== 'å¾…å®¡æ‰¹') {
        alert('å½“å‰è®¢å•å°šæœªå¤„äºâ€œå¾…å®¡æ‰¹â€çŠ¶æ€ï¼Œæ— æ³•æ‰§è¡Œå®¡æ‰¹é©³å›æ¼”ç¤ºã€‚');
        return;
      }
      setOrderStatus('å·²é©³å›');
      currentOrder.status = 'å·²é©³å›';
      appendTimeline('å®¡æ‰¹é©³å›ï¼Œè®¢å•æµç¨‹ç»ˆæ­¢');
      const idx = orderHistory.findIndex(o => o.orderNo === currentOrder.orderNo);
      if (idx === -1) orderHistory.unshift({ ...currentOrder });
      else orderHistory[idx] = { ...currentOrder };
      renderOrderList();
    });

      // ============== è®¢å•åˆ—è¡¨æ¸²æŸ“ï¼ˆå«è°ƒæ‹¨è®¢å• + æ•…éšœå·¥å•ï¼‰ ==============
    function renderOrderList() {
      orderListEl.innerHTML = '';
      const hasTransfer = orderHistory.length > 0;
      const hasFault    = faultTickets.length > 0;

      if (!hasTransfer && !hasFault) {
        const div = document.createElement('div');
        div.style.fontSize = '11px';
        div.style.color = '#9ca3af';
        div.textContent = 'æš‚æ— è®¢å•/å·¥å•ï¼Œè¯·å…ˆåœ¨â€œè°ƒæ‹¨å‡ºå…¥åº“â€æˆ–â€œæ•…éšœç»ˆç«¯â€é¡µåˆ›å»ºã€‚';
        orderListEl.appendChild(div);
        return;
      }

      // 1ï¼‰è°ƒæ‹¨å‡ºå…¥åº“è®¢å•
      orderHistory.forEach(order => {
        const item = document.createElement('div');
        item.className = 'order-item';

        const header = document.createElement('div');
        header.className = 'order-header';

        const title = document.createElement('div');
        title.className = 'order-title';
        title.textContent = order.orderNo;

        const statusSpan = document.createElement('span');
        statusSpan.className = 'badge-status';
        statusSpan.textContent = order.status;
        if (order.status === 'è‰ç¨¿')   statusSpan.classList.add('badge-draft');
        if (order.status === 'å¾…å®¡æ‰¹') statusSpan.classList.add('badge-pending');
        if (order.status === 'å·²é€šè¿‡') statusSpan.classList.add('badge-pass');
        if (order.status === 'å·²é©³å›') statusSpan.classList.add('badge-reject');

        header.appendChild(title);
        header.appendChild(statusSpan);

        const meta1 = document.createElement('div');
        meta1.className = 'order-meta';
        const left1 = document.createElement('span');
        left1.textContent = order.type + ' | è®¾å¤‡æ•°ï¼š' + order.devices.length;
        const right1 = document.createElement('span');
        right1.textContent = 'åˆ›å»ºäººï¼š' + order.creator;
        meta1.appendChild(left1);
        meta1.appendChild(right1);

        const meta2 = document.createElement('div');
        meta2.className = 'order-meta';
        const left2 = document.createElement('span');
        left2.textContent = 'è°ƒå‡ºï¼š' + order.fromStore;
        const right2 = document.createElement('span');
        right2.textContent = 'è°ƒå…¥ï¼š' + order.toStore;
        meta2.appendChild(left2);
        meta2.appendChild(right2);

        const tagRow = document.createElement('div');
        tagRow.style.marginTop = '4px';
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = 'ã€è°ƒæ‹¨ã€‘ç‚¹å‡»å›å¡«åˆ°å½“å‰è®¢å•';
        tagRow.appendChild(tag);

        item.appendChild(header);
        item.appendChild(meta1);
        item.appendChild(meta2);
        item.appendChild(tagRow);

        item.addEventListener('click', () => {
          currentOrder = { ...order };
          fieldOrderType.value = order.type;
          fieldOrderNo.value   = order.orderNo;
          fieldFromStore.value = order.fromStore;
          fieldToStore.value   = order.toStore;
          fieldCreator.value   = order.creator;
          fieldPhone.value     = order.phone || '';
          fieldRemark.value    = order.remark || '';
          setOrderStatus(order.status);
          renderDeviceList();
          appendTimeline('ä»è®¢å•åˆ—è¡¨å›å¡«è®¢å•ï¼š' + order.orderNo);
          document.querySelector('.tab-item[data-view="transfer"]').click();
        });

        orderListEl.appendChild(item);
      });

      // 2ï¼‰æ•…éšœç»ˆç«¯å·¥å•
      faultTickets.forEach(t => {
        const item = document.createElement('div');
        item.className = 'order-item';

        const header = document.createElement('div');
        header.className = 'order-header';

        const title = document.createElement('div');
        title.className = 'order-title';
        title.textContent = t.faultNo;

        const statusSpan = document.createElement('span');
        statusSpan.className = 'badge-status';
        statusSpan.textContent = t.status;
        if (t.status === 'è‰ç¨¿')   statusSpan.classList.add('badge-draft');
        if (t.status === 'å·²æäº¤') statusSpan.classList.add('badge-pass');

        header.appendChild(title);
        header.appendChild(statusSpan);

        const meta1 = document.createElement('div');
        meta1.className = 'order-meta';
        const left1 = document.createElement('span');
        left1.textContent = 'æ•…éšœç±»å‹ï¼š' + (t.detail?.type || 'æœªçŸ¥');
        const right1 = document.createElement('span');
        right1.textContent = t.basic?.city + ' Â· ' + t.basic?.county;
        meta1.appendChild(left1);
        meta1.appendChild(right1);

        const meta2 = document.createElement('div');
        meta2.className = 'order-meta';
        const left2 = document.createElement('span');
        left2.textContent = 'åé¦ˆäººï¼š' + (t.basic?.reporter || '');
        const right2 = document.createElement('span');
        right2.textContent = t.device?.sn || 'æœªå…³è”ç»ˆç«¯';
        meta2.appendChild(left2);
        meta2.appendChild(right2);

        const tagRow = document.createElement('div');
        tagRow.style.marginTop = '4px';
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = 'ã€æ•…éšœã€‘ç‚¹å‡»å›å¡«åˆ°æ•…éšœå·¥å•';
        tagRow.appendChild(tag);

        item.appendChild(header);
        item.appendChild(meta1);
        item.appendChild(meta2);
        item.appendChild(tagRow);

        // å›å¡«åˆ°æ•…éšœç»ˆç«¯é—­ç¯ç®¡ç†é¡µï¼ˆä»…è‰ç¨¿æ”¯æŒä¿®æ”¹ï¼‰
        item.addEventListener('click', () => {
          currentFaultTicket = { ...t };
          faultNoInput.value    = t.faultNo;
          faultSource.value     = t.basic.source;
          faultCity.value       = t.basic.city;
          faultCounty.value     = t.basic.county;
          faultReporter.value   = t.basic.reporter;
          faultPhone.value      = t.basic.phone || '';
          faultType.value       = t.detail.type;
          faultLevel.value      = t.detail.level || 'ä¸€èˆ¬';
          faultDesc.value       = t.detail.desc;
          faultUsage.value      = t.detail.usage || '';
          setFaultStatus(t.status);

          if (t.device) {
            faultDevCode.textContent     = t.device.code;
            faultDevSn.textContent       = t.device.sn;
            faultDevType.textContent     = t.device.type;
            faultDevVendor.textContent   = t.device.vendor;
            faultDevModel.textContent    = t.device.model;
            faultDevInTime.textContent   = t.device.inTime;
            faultDevStatus.textContent   = t.device.status;
            faultDevLocation.textContent = t.device.location;
          } else {
            clearFaultDeviceView();
          }

          // åˆ‡æ¢åˆ°åº•éƒ¨â€œæ•…éšœç»ˆç«¯â€Tab
          document.querySelector('.tab-item[data-view="fault"]').click();
        });

        orderListEl.appendChild(item);
      });
    }

    // åˆå§‹åŒ–
    renderDeviceList();
    renderCodeTags([]);
    resetFaultForm();
    renderFaultList();
  </script>
</body>
</html>
