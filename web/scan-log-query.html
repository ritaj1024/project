<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å®¶å®½è¿ç»´æ”¯æ’‘ç³»ç»Ÿ Â· æ‰«ç è®°å½•æŸ¥è¯¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    a { text-decoration: none; color: inherit; }

    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100vh;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      height: 56px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid rgba(148,163,184,0.4);
      font-size: 16px;
      font-weight: 600;
    }
    .sidebar-header span.logo {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg,#2563eb,#06b6d4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-right: 8px;
    }
    .menu-group-title {
      font-size: 12px;
      color: #9ca3af;
      padding: 16px 16px 4px;
    }
    .menu-item {
      padding: 8px 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      cursor: pointer;
      color: #e5e7eb;
    }
    .menu-item span.icon {
      margin-right: 6px;
      font-size: 15px;
    }
    .menu-item.active {
      background: rgba(37,99,235,0.18);
      color: #ffffff;
    }
    .submenu {
      padding-left: 34px;
      padding-bottom: 10px;
    }
    .submenu-item {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #cbd5f5;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .submenu-item.active {
      background: #1d4ed8;
      color: #fff;
    }

    /* é¡¶éƒ¨æ  + å†…å®¹ */
    .main {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .topbar {
      height: 56px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      font-size: 14px;
    }
    .breadcrumb {
      font-size: 12px;
      color: #6b7280;
    }
    .breadcrumb span.current {
      color: #111827;
      font-weight: 500;
    }
    .topbar-right {
      font-size: 12px;
      color: #6b7280;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 18px 20px 24px;
    }

    .page-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-title-sub {
      font-size: 12px;
      color: #6b7280;
    }

    /* ç­›é€‰å¡ç‰‡ */
    .card {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
      padding: 14px 14px 10px;
      margin-bottom: 14px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: 10px 12px;
      font-size: 13px;
      align-items: center;
    }
    .form-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .form-label {
      width: 96px;
      text-align: right;
      font-size: 12px;
      color: #4b5563;
      white-space: nowrap;
    }
    .form-control {
      flex: 1;
    }
    select, input[type="text"], input[type="date"] {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 5px 8px;
      font-size: 12px;
      outline: none;
    }
    select:focus, input[type="text"]:focus, input[type="date"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.18);
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }
    .btn {
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 16px;
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #ffffff;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
    }
    .btn-secondary {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1d4ed8;
    }

    /* è¡¨æ ¼ */
    .table-wrapper {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
      padding: 10px 14px 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th {
      color: #4b5563;
      font-weight: 500;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0 8px;
      border-radius: 999px;
      font-size: 11px;
      line-height: 18px;
    }
    .tag-success {
      background: #dcfce7;
      color: #166534;
    }
    .tag-warning {
      background: #fef3c7;
      color: #92400e;
    }
    .tag-danger {
      background: #fee2e2;
      color: #b91c1c;
    }
    .tag-gray {
      background: #e5e7eb;
      color: #374151;
    }
    .text-link {
      font-size: 12px;
      color: #2563eb;
      cursor: pointer;
    }

    .table-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
    }
    .pager {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .pager button {
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .pager button.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #2563eb;
    }

    /* å¼¹çª— */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      width: 720px;
      max-width: 96%;
      max-height: 80vh;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .modal-title {
      font-weight: 600;
    }
    .modal-close {
      cursor: pointer;
      font-size: 18px;
      color: #6b7280;
    }
    .modal-body {
      padding: 10px 14px 12px;
      overflow-y: auto;
      font-size: 12px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px 16px;
      margin-bottom: 8px;
    }
    .detail-label {
      color: #6b7280;
      margin-bottom: 2px;
    }
    .detail-value {
      font-weight: 500;
    }
    pre.detail-json {
      background: #0b1120;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 11px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo">A</span>
      <span>AMS å®¶å®¢ç»ˆç«¯ç®¡ç†</span>
    </div>

    <div>
      <div class="menu-group-title">ç»ˆç«¯è¿è¥</div>
      <div class="menu-item">
        <span class="icon">ğŸ“¦</span>
        <span>è°ƒæ‹¨å‡ºå…¥åº“</span>
      </div>

      <div class="menu-group-title">é£æ§ & è®°å½•</div>
      <div class="menu-item active">
        <span class="icon">ğŸ“‹</span>
        <span>æ‰«ç è®°å½•ç®¡ç†</span>
      </div>
      <div class="submenu">
        <div class="submenu-item active">
          <span>æ‰«ç è®°å½•æŸ¥è¯¢</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- ä¸»åŒºåŸŸ -->
  <div class="main">
    <header class="topbar">
      <div>
        <div class="breadcrumb">
          ç»ˆç«¯è¿è¥å¹³å° / æ‰«ç è®°å½•ç®¡ç† / <span class="current">æ‰«ç è®°å½•æŸ¥è¯¢</span>
        </div>
      </div>
      <div class="topbar-right">
        æ”¯æŒæŒ‰ä¸šåŠ¡ç±»å‹ã€æ‰«ç ç»“æœã€æ“ä½œäººã€å·¥å·ã€æ‰«ç æ¥æºç­‰ç»„åˆæŸ¥è¯¢
      </div>
    </header>

    <main class="content">
      <div class="page-title">
        <div>
          æ‰«ç è®°å½•æŸ¥è¯¢
          <div class="page-title-sub">æŸ¥è¯¢å¹¶å¯¼å‡º APP ç«¯è°ƒæ‹¨å‡ºå…¥åº“æ‰«ç è¡Œä¸ºä¸ä¸šåŠ¡å·¥å•çš„å…³è”è®°å½•</div>
        </div>
        <button id="btnExport" class="btn btn-secondary">â¬‡ å¯¼å‡ºå½“å‰ç»“æœ</button>
      </div>

      <!-- ç­›é€‰æ¡ä»¶ -->
      <section class="card">
        <div class="filter-grid">
          <div class="form-item">
            <label class="form-label">ä¸šåŠ¡ç±»å‹</label>
            <div class="form-control">
              <select id="filterBizType">
                <option value="">å…¨éƒ¨</option>
                <option value="è°ƒæ‹¨å‡ºåº“">è°ƒæ‹¨å‡ºåº“</option>
                <option value="è°ƒæ‹¨å…¥åº“">è°ƒæ‹¨å…¥åº“</option>
              </select>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æ‰«ç ç»“æœ</label>
            <div class="form-control">
              <select id="filterScanResult">
                <option value="">å…¨éƒ¨</option>
                <option value="æˆåŠŸ">æˆåŠŸ</option>
                <option value="å°è´¦æ— è®°å½•">å°è´¦æ— è®°å½•</option>
                <option value="é‡å¤æ‰«ç ">é‡å¤æ‰«ç </option>
                <option value="æ ¡éªŒå¤±è´¥">æ ¡éªŒå¤±è´¥</option>
              </select>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æ‰«ç æ¥æº</label>
            <div class="form-control">
              <select id="filterSource">
                <option value="">å…¨éƒ¨</option>
                <option value="è£…ç»´APP">è£…ç»´APP</option>
                <option value="WEB">WEB</option>
                <option value="æ¥å£æœåŠ¡">æ¥å£æœåŠ¡</option>
              </select>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">ä¸šåŠ¡å·¥å•å· / è®¢å•å·</label>
            <div class="form-control">
              <input id="filterBizOrderNo" type="text" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰</label>
            <div class="form-control">
              <input id="filterSn" type="text" placeholder="SN æˆ–æ¡ç å†…å®¹">
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æ“ä½œäººå§“å / å·¥å·</label>
            <div class="form-control">
              <input id="filterOperator" type="text" placeholder="å¦‚ï¼šå¼ ä¸‰ / 1008611">
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æ“ä½œæ—¶é—´èµ·</label>
            <div class="form-control">
              <input id="filterStartDate" type="date">
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æ“ä½œæ—¶é—´æ­¢</label>
            <div class="form-control">
              <input id="filterEndDate" type="date">
            </div>
          </div>
        </div>

        <div class="filter-actions">
          <button id="btnReset" class="btn btn-outline">é‡ç½®</button>
          <button id="btnSearch" class="btn btn-primary">æŸ¥è¯¢</button>
        </div>
      </section>

      <!-- ç»“æœåˆ—è¡¨ -->
      <section class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th style="width:40px;">åºå·</th>
            <th>ä¸šåŠ¡ç±»å‹</th>
            <th>ä¸šåŠ¡å·¥å•å· / è®¢å•å·</th>
            <th>è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰</th>
            <th>æ‰«ç ç»“æœ</th>
            <th>å°è´¦åŒ¹é…ç»“æœ</th>
            <th>è¿”å›ç»“æœæè¿°</th>
            <th>æ“ä½œäºº</th>
            <th>æ‰«ç æ¥æº</th>
            <th>æ“ä½œæ—¶é—´</th>
            <th>è€—æ—¶(ms)</th>
            <th>è¯·æ±‚ID</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="tableBody">
          <!-- JS æ¸²æŸ“ -->
          </tbody>
        </table>

        <div class="table-footer">
          <span id="summaryText">å…± 0 æ¡è®°å½•</span>
          <div class="pager">
            <button id="btnPrev">&lt;</button>
            <button id="pageInfo" class="active">1 / 1</button>
            <button id="btnNext">&gt;</button>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- è¯¦æƒ…å¼¹çª— -->
<div id="detailModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æ‰«ç è¯¦æƒ…</div>
      <div id="btnDetailClose" class="modal-close">âœ•</div>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="detailGrid">
        <!-- JS å¡«å……å…³é”®å­—æ®µ -->
      </div>
      <div style="margin-bottom:4px;font-size:12px;color:#4b5563;">è¯·æ±‚ / å“åº”åŸæ–‡ï¼š</div>
      <pre id="detailRaw" class="detail-json"></pre>
    </div>
  </div>
</div>

<script>
  // ======== æ¨¡æ‹Ÿåç«¯è¿”å›çš„â€œè°ƒæ‹¨å‡ºåº“ / è°ƒæ‹¨å…¥åº“â€æ‰«ç è®°å½• ========
  const allRows = [
    {
      id: 1,
      bizType: 'è°ƒæ‹¨å‡ºåº“',
      bizOrderNo: 'DBDD202412050930',
      sn: 'SN1234567890',
      scanResult: 'æˆåŠŸ',
      matchResult: 'å·²åŒ¹é…å°è´¦',
      description: 'æ ¡éªŒé€šè¿‡ï¼ŒåŠ å…¥è°ƒæ‹¨å‡ºåº“è®¢å•ã€‚',
      operator: 'å¼ ä¸‰ / 1008611',
      source: 'è£…ç»´APP',
      opTime: '2024-12-05 09:30:21',
      duration: 128,
      reqId: 'REQ-20241205-0001',
      raw: {
        request: { url: '/api/scan/dispatch-out', sn: 'SN1234567890', orderNo: 'DBDD202412050930' },
        response: { code: 0, msg: 'OK', match: true }
      }
    },
    {
      id: 2,
      bizType: 'è°ƒæ‹¨å‡ºåº“',
      bizOrderNo: 'DBDD202412050930',
      sn: 'SN2233445566',
      scanResult: 'å°è´¦æ— è®°å½•',
      matchResult: 'ç³»ç»Ÿæ— å°è´¦è®°å½•',
      description: 'æœªåœ¨ç»ˆç«¯å°è´¦ä¸­æ‰¾åˆ°åŒ¹é…ä¸²ç ã€‚',
      operator: 'å¼ ä¸‰ / 1008611',
      source: 'è£…ç»´APP',
      opTime: '2024-12-05 09:30:32',
      duration: 156,
      reqId: 'REQ-20241205-0002',
      raw: {
        request: { url: '/api/scan/dispatch-out', sn: 'SN2233445566', orderNo: 'DBDD202412050930' },
        response: { code: 1001, msg: 'SN not found in catalog' }
      }
    },
    {
      id: 3,
      bizType: 'è°ƒæ‹¨å…¥åº“',
      bizOrderNo: 'DBDD202412041530',
      sn: 'SN9988776655',
      scanResult: 'é‡å¤æ‰«ç ',
      matchResult: 'å·²åœ¨æœ¬å•ç”³è¯·å•ä¸­',
      description: 'å½“å‰è®¢å•å·²å­˜åœ¨è¯¥è®¾å¤‡ï¼Œç³»ç»Ÿé˜»æ­¢é‡å¤å…¥åº“ã€‚',
      operator: 'æå›› / 1008612',
      source: 'è£…ç»´APP',
      opTime: '2024-12-04 13:14:09',
      duration: 102,
      reqId: 'REQ-20241204-0001',
      raw: {
        request: { url: '/api/scan/dispatch-in', sn: 'SN9988776655', orderNo: 'DBDD202412041530' },
        response: { code: 1002, msg: 'Duplicate SN for current order' }
      }
    },
    {
      id: 4,
      bizType: 'è°ƒæ‹¨å‡ºåº“',
      bizOrderNo: 'ZJDD202412031110',
      sn: 'SN0000000000',
      scanResult: 'æ ¡éªŒå¤±è´¥',
      matchResult: 'ä¸²ç ä¸ç»ˆç«¯ç±»å‹ä¸ç¬¦',
      description: 'è£…æœºå·¥å•è¦æ±‚â€œå…‰çŒ«â€ï¼Œå½“å‰ä¸²ç å°è´¦ç»ˆç«¯ç±»å‹ä¸ºâ€œæœºé¡¶ç›’â€ï¼Œæ ¡éªŒä¸é€šè¿‡ã€‚',
      operator: 'ç‹äº” / 1008613',
      source: 'è£…ç»´APP',
      opTime: '2024-12-03 11:10:05',
      duration: 210,
      reqId: 'REQ-20241203-0009',
      raw: {
        request: { url: '/api/scan/dispatch-out', sn: 'SN0000000000', orderNo: 'ZJDD202412031110' },
        response: { code: 1003, msg: 'Device type mismatch' }
      }
    }
  ];

  // ç®€å•åˆ†é¡µï¼šæ¯é¡µ 10 æ¡
  const pageSize = 10;
  let currentPage = 1;
  let currentFiltered = [...allRows];

  const tableBody = document.getElementById('tableBody');
  const summaryText = document.getElementById('summaryText');
  const pageInfo = document.getElementById('pageInfo');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  function renderTable() {
    const total = currentFiltered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const pageRows = currentFiltered.slice(start, start + pageSize);

    tableBody.innerHTML = '';
    pageRows.forEach((row, index) => {
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td');
      tdIndex.textContent = start + index + 1;
      tr.appendChild(tdIndex);

      const tdBizType = document.createElement('td');
      tdBizType.textContent = row.bizType;
      tr.appendChild(tdBizType);

      const tdBizOrder = document.createElement('td');
      tdBizOrder.textContent = row.bizOrderNo;
      tr.appendChild(tdBizOrder);

      const tdSn = document.createElement('td');
      tdSn.textContent = row.sn;
      tr.appendChild(tdSn);

      const tdScanResult = document.createElement('td');
      const tagScan = document.createElement('span');
      tagScan.className = 'tag ' + (
        row.scanResult === 'æˆåŠŸ' ? 'tag-success' :
          (row.scanResult === 'æ ¡éªŒå¤±è´¥' ? 'tag-danger' : 'tag-warning')
      );
      tagScan.textContent = row.scanResult;
      tdScanResult.appendChild(tagScan);
      tr.appendChild(tdScanResult);

      const tdMatch = document.createElement('td');
      tdMatch.textContent = row.matchResult;
      tr.appendChild(tdMatch);

      const tdDesc = document.createElement('td');
      tdDesc.textContent = row.description;
      tr.appendChild(tdDesc);

      const tdOp = document.createElement('td');
      tdOp.textContent = row.operator;
      tr.appendChild(tdOp);

      const tdSource = document.createElement('td');
      tdSource.textContent = row.source;
      tr.appendChild(tdSource);

      const tdTime = document.createElement('td');
      tdTime.textContent = row.opTime;
      tr.appendChild(tdTime);

      const tdDur = document.createElement('td');
      tdDur.textContent = row.duration;
      tr.appendChild(tdDur);

      const tdReq = document.createElement('td');
      tdReq.textContent = row.reqId;
      tr.appendChild(tdReq);

      const tdAction = document.createElement('td');
      const a = document.createElement('span');
      a.className = 'text-link';
      a.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
      a.addEventListener('click', () => openDetail(row));
      tdAction.appendChild(a);
      tr.appendChild(tdAction);

      tableBody.appendChild(tr);
    });

    summaryText.textContent = `å…± ${total} æ¡è®°å½•`;
    pageInfo.textContent = `${total === 0 ? 0 : currentPage} / ${Math.max(1, totalPages)}`;
  }

  // ç­›é€‰
  function applyFilter() {
    const bizType = document.getElementById('filterBizType').value.trim();
    const scanResult = document.getElementById('filterScanResult').value.trim();
    const source = document.getElementById('filterSource').value.trim();
    const bizOrderNo = document.getElementById('filterBizOrderNo').value.trim();
    const sn = document.getElementById('filterSn').value.trim();
    const operator = document.getElementById('filterOperator').value.trim();
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    currentFiltered = allRows.filter(row => {
      if (bizType && row.bizType !== bizType) return false;
      if (scanResult && row.scanResult !== scanResult) return false;
      if (source && row.source !== source) return false;
      if (bizOrderNo && !row.bizOrderNo.includes(bizOrderNo)) return false;
      if (sn && !row.sn.includes(sn)) return false;
      if (operator && row.operator.indexOf(operator) === -1) return false;

      if (startDate || endDate) {
        const ts = new Date(row.opTime.replace(/-/g,'/')).getTime();
        if (startDate) {
          const s = new Date(startDate + ' 00:00:00').getTime();
          if (ts < s) return false;
        }
        if (endDate) {
          const e = new Date(endDate + ' 23:59:59').getTime();
          if (ts > e) return false;
        }
      }
      return true;
    });

    currentPage = 1;
    renderTable();
  }

  document.getElementById('btnSearch').addEventListener('click', applyFilter);

  document.getElementById('btnReset').addEventListener('click', () => {
    ['filterBizType','filterScanResult','filterSource',
      'filterBizOrderNo','filterSn','filterOperator',
      'filterStartDate','filterEndDate'
    ].forEach(id => {
      document.getElementById(id).value = '';
    });
    currentFiltered = [...allRows];
    currentPage = 1;
    renderTable();
  });

  btnPrev.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  });
  btnNext.addEventListener('click', () => {
    const totalPages = Math.max(1, Math.ceil(currentFiltered.length / pageSize));
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  });

  // è¯¦æƒ…å¼¹æ¡†
  const detailModal = document.getElementById('detailModal');
  const btnDetailClose = document.getElementById('btnDetailClose');
  const detailGrid = document.getElementById('detailGrid');
  const detailRaw = document.getElementById('detailRaw');

  function openDetail(row) {
    detailGrid.innerHTML = '';
    const fields = [
      ['ä¸šåŠ¡ç±»å‹', row.bizType],
      ['ä¸šåŠ¡å·¥å•å· / è®¢å•å·', row.bizOrderNo],
      ['è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰', row.sn],
      ['æ‰«ç ç»“æœ', row.scanResult],
      ['å°è´¦åŒ¹é…ç»“æœ', row.matchResult],
      ['è¿”å›ç»“æœæè¿°', row.description],
      ['æ“ä½œäºº', row.operator],
      ['æ‰«ç æ¥æº', row.source],
      ['æ“ä½œæ—¶é—´', row.opTime],
      ['è€—æ—¶(ms)', row.duration.toString()],
      ['è¯·æ±‚ID', row.reqId]
    ];
    fields.forEach(([label, value]) => {
      const wrapper = document.createElement('div');
      const l = document.createElement('div');
      l.className = 'detail-label';
      l.textContent = label;
      const v = document.createElement('div');
      v.className = 'detail-value';
      v.textContent = value;
      wrapper.appendChild(l);
      wrapper.appendChild(v);
      detailGrid.appendChild(wrapper);
    });

    detailRaw.textContent = JSON.stringify(row.raw, null, 2);
    detailModal.classList.add('active');
  }

  btnDetailClose.addEventListener('click', () => {
    detailModal.classList.remove('active');
  });
  detailModal.addEventListener('click', (e) => {
    if (e.target === detailModal) {
      detailModal.classList.remove('active');
    }
  });

  // å¯¼å‡º CSVï¼ˆå¯¼å‡ºå½“å‰ç­›é€‰ç»“æœï¼‰
  document.getElementById('btnExport').addEventListener('click', () => {
    if (!currentFiltered.length) {
      alert('å½“å‰æ— å¯å¯¼å‡ºçš„è®°å½•ã€‚');
      return;
    }
    const header = [
      'ä¸šåŠ¡ç±»å‹','ä¸šåŠ¡å·¥å•å·/è®¢å•å·','è®¾å¤‡è¯†åˆ«ç ï¼ˆä¸²ç ï¼‰','æ‰«ç ç»“æœ',
      'å°è´¦åŒ¹é…ç»“æœ','è¿”å›ç»“æœæè¿°','æ“ä½œäºº','æ‰«ç æ¥æº',
      'æ“ä½œæ—¶é—´','è€—æ—¶(ms)','è¯·æ±‚ID'
    ];
    const lines = [header.join(',')];
    currentFiltered.forEach(r => {
      lines.push([
        r.bizType,
        r.bizOrderNo,
        r.sn,
        r.scanResult,
        r.matchResult,
        `"${r.description.replace(/"/g,'""')}"`,
        r.operator,
        r.source,
        r.opTime,
        r.duration,
        r.reqId
      ].join(','));
    });
    const blob = new Blob([lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'scan-log-export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // åˆå§‹åŒ–
  currentFiltered = [...allRows];
  renderTable();
</script>
</body>
</html>
